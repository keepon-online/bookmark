# 清理空文件夹 - 流程图

## 1. 核心流程

```
┌─────────────────────────────────────────────────────────────┐
│                     用户触发清理                             │
└──────────────────────────┬──────────────────────────────────┘
                           │
                           ▼
┌─────────────────────────────────────────────────────────────┐
│  配置清理选项                                                │
│  - recursive: 是否递归清理                                   │
│  - excludeRoot: 是否排除根目录                              │
│  - minAge: 最小存在时间                                      │
└──────────────────────────┬──────────────────────────────────┘
                           │
                           ▼
┌─────────────────────────────────────────────────────────────┐
│  点击"预览清理"                                              │
└──────────────────────────┬──────────────────────────────────┘
                           │
                           ▼
┌─────────────────────────────────────────────────────────────┐
│  findEmptyFolders() - 查找空文件夹                           │
│  ┌─────────────────────────────────────────────────────┐   │
│  │ 1. 批量查询所有文件夹和书签                         │   │
│  │ 2. 构建文件夹树和统计信息                           │   │
│  │ 3. 计算每个文件夹的书签数和子文件夹数               │   │
│  │ 4. 应用过滤规则（minAge, excludeRoot等）           │   │
│  └─────────────────────────────────────────────────────┘   │
└──────────────────────────┬──────────────────────────────────┘
                           │
                           ▼
┌─────────────────────────────────────────────────────────────┐
│  previewEmptyFolders() - 预览清理结果                        │
│  ┌─────────────────────────────────────────────────────┐   │
│  │ 1. 应用保留规则                                     │   │
│  │    - 智能文件夹保留                                 │   │
│  │    - 系统文件夹保留                                 │   │
│  │    - 有子文件夹的保留（非递归模式）                 │   │
│  │ 2. 生成警告信息                                     │   │
│  │ 3. 分类：toDelete vs toKeep                        │   │
│  └─────────────────────────────────────────────────────┘   │
└──────────────────────────┬──────────────────────────────────┘
                           │
                           ▼
┌─────────────────────────────────────────────────────────────┐
│  显示预览结果                                                │
│  ┌─────────────────────────────────────────────────────┐   │
│  │ • 将被删除的文件夹列表                              │   │
│  │ • 将被保留的文件夹列表及原因                        │   │
│  │ • 警告信息                                          │   │
│  └─────────────────────────────────────────────────────┘   │
└──────────────────────────┬──────────────────────────────────┘
                           │
                           ▼
┌─────────────────────────────────────────────────────────────┐
│  用户确认并点击"确认清理"                                   │
└──────────────────────────┬──────────────────────────────────┘
                           │
                           ▼
┌─────────────────────────────────────────────────────────────┐
│  deleteEmptyFolders() - 执行清理                            │
│  ┌─────────────────────────────────────────────────────┐   │
│  │ FOR EACH folder toDelete:                           │   │
│  │   1. 调用 folderService.delete(id)                  │   │
│  │   2. 递归删除子文件夹                               │   │
│  │   3. 处理错误并记录                                 │   │
│  │ END FOR                                              │   │
│  │                                                       │   │
│  │ 返回清理结果：                                       │   │
│  │ - deleted: 删除数量                                  │   │
│  │ - kept: 保留数量                                    │   │
│  │ - warnings: 警告列表                                │   │
│  │ - duration: 执行时间                                │   │
│  └─────────────────────────────────────────────────────┘   │
└──────────────────────────┬──────────────────────────────────┘
                           │
                           ▼
┌─────────────────────────────────────────────────────────────┐
│  显示清理结果                                                │
│  • 删除的文件夹数量                                          │
│  • 保留的文件夹数量                                          │
│  • 执行时间                                                  │
└─────────────────────────────────────────────────────────────┘
```

## 2. 空文件夹识别算法

```
输入: options { recursive, excludeRoot, minAge }
输出: EmptyFolderInfo[]

┌─────────────────────────────────────────────────────────────┐
│  步骤1: 批量加载数据                                         │
│  ┌─────────────────────────────────────────────────────┐   │
│  │ allFolders = db.folders.toArray()                   │   │
│  │ allBookmarks = db.bookmarks.toArray()               │   │
│  │                                                       │   │
│  │ 使用 Map 优化查询：                                   │   │
│  │ folderMap: Map<id, Folder>                          │   │
│  │ folderBookmarksCount: Map<id, number>               │   │
│  │ folderChildren: Map<id, Set<childId>>               │   │
│  └─────────────────────────────────────────────────────┘   │
└──────────────────────────┬──────────────────────────────────┘
                           │
                           ▼
┌─────────────────────────────────────────────────────────────┐
│  步骤2: 统计书签分布                                         │
│  ┌─────────────────────────────────────────────────────┐   │
│  │ FOR EACH bookmark:                                  │   │
│  │   IF bookmark.folderId:                             │   │
│  │     folderBookmarksCount[bookmark.folderId]++       │   │
│  │   END IF                                            │   │
│  │ END FOR                                              │   │
│  └─────────────────────────────────────────────────────┘   │
└──────────────────────────┬──────────────────────────────────┘
                           │
                           ▼
┌─────────────────────────────────────────────────────────────┐
│  步骤3: 构建文件夹树                                         │
│  ┌─────────────────────────────────────────────────────┐   │
│  │ FOR EACH folder:                                    │   │
│  │   IF folder.parentId:                               │   │
│  │     folderChildren[folder.parentId].add(folder.id)  │   │
│  │   END IF                                            │   │
│  │ END FOR                                              │   │
│  └─────────────────────────────────────────────────────┘   │
└──────────────────────────┬──────────────────────────────────┘
                           │
                           ▼
┌─────────────────────────────────────────────────────────────┐
│  步骤4: 计算后代文件夹数（递归）                             │
│  ┌─────────────────────────────────────────────────────┐   │
│  │ FUNCTION calculateDescendants(folderId):            │   │
│  │   children = folderChildren[folderId]               │   │
│  │   count = children.size                             │   │
│  │   FOR EACH childId in children:                     │   │
│  │     count += calculateDescendants(childId)          │   │
│  │   END FOR                                            │   │
│  │   RETURN count                                       │   │
│  │ END FUNCTION                                         │   │
│  └─────────────────────────────────────────────────────┘   │
└──────────────────────────┬──────────────────────────────────┘
                           │
                           ▼
┌─────────────────────────────────────────────────────────────┐
│  步骤5: 识别空文件夹                                         │
│  ┌─────────────────────────────────────────────────────┐   │
│  │ FOR EACH folder:                                    │   │
│  │   bookmarksCount = folderBookmarksCount[id]         │   │
│  │   directChildrenCount = folderChildren[id].size     │   │
│  │   allDescendantsCount = calculateDescendants(id)    │   │
│  │   age = now - folder.createdAt                      │   │
│  │                                                       │   │
│  │   isEmpty = (bookmarksCount == 0)                   │   │
│  │             && (recursive ? allDescendantsCount == 0│   │
│  │                          : directChildrenCount == 0)│   │
│  │                                                       │   │
│  │   IF isEmpty AND age >= minAge:                     │   │
│  │     ADD to emptyFolders                             │   │
│  │   END IF                                             │   │
│  │ END FOR                                              │   │
│  └─────────────────────────────────────────────────────┘   │
└──────────────────────────┬──────────────────────────────────┘
                           │
                           ▼
                    返回 emptyFolders
```

## 3. 保留规则判断

```
输入: EmptyFolderInfo
输出: shouldKeep | shouldNotKeep

┌─────────────────────────────────────────────────────────────┐
│  检查点1: 是否是智能文件夹？                                 │
│  IF folder.isSmartFolder:                                   │
│    → 保留（原因：智能文件夹需要保留）                        │
└──────────────────────────┬──────────────────────────────────┘
                           │ 否
                           ▼
┌─────────────────────────────────────────────────────────────┐
│  检查点2: 是否有子文件夹？                                   │
│  IF allDescendantsCount > 0:                                │
│    → 保留（原因：包含 N 个子文件夹）                         │
└──────────────────────────┬──────────────────────────────────┘
                           │ 否
                           ▼
┌─────────────────────────────────────────────────────────────┐
│  检查点3: 是否是系统文件夹？                                 │
│  IF folder.name in ['收藏', '未分类', '全部', '最近使用']:   │
│    → 保留（原因：系统文件夹需要保留）                        │
└──────────────────────────┬──────────────────────────────────┘
                           │ 否
                           ▼
┌─────────────────────────────────────────────────────────────┐
│  检查点4: 是否太新？                                         │
│  IF age < 24小时:                                           │
│    → 保留（原因：创建时间小于24小时）                        │
└──────────────────────────┬──────────────────────────────────┘
                           │ 否
                           ▼
                    可以删除
```

## 4. 删除流程

```
输入: EmptyFolderInfo[]
输出: CleanupEmptyFoldersResult

┌─────────────────────────────────────────────────────────────┐
│  FOR EACH info in toDelete:                                 │
│  ┌─────────────────────────────────────────────────────┐   │
│  │  TRY:                                               │   │
│  │    folderService.delete(info.folder.id)            │   │
│  │    → 自动递归删除子文件夹                          │   │
│  │    deleted++                                        │   │
│  │  CATCH error:                                       │   │
│  │    warnings.push(`删除失败: ${error.message}`)      │   │
│  │  END TRY                                            │   │
│  └─────────────────────────────────────────────────────┘   │
│  END FOR                                                    │
│                                                              │
│  返回 { deleted, kept, warnings, duration }                  │
└─────────────────────────────────────────────────────────────┘
```

## 5. UI 交互流程

```
┌─────────────────────┐
│   文件夹列表页面    │
└──────────┬──────────┘
           │
           │ 点击"清理空文件夹"
           ▼
┌─────────────────────────────────────────────────────────────┐
│  清理面板弹窗                                                │
│  ┌─────────────────────────────────────────────────────┐   │
│  │ [x] 递归清理                                         │   │
│  │ [x] 排除根目录                                       │   │
│  │ [x] 最小存在时间: 1天 ▼                             │   │
│  │                                                       │   │
│  │ [预览清理]                                            │   │
│  └─────────────────────────────────────────────────────┘   │
└──────────────────────────┬──────────────────────────────────┘
                           │
                           │ 点击预览
                           ▼
┌─────────────────────────────────────────────────────────────┐
│  预览结果                                                    │
│  ┌─────────────────────────────────────────────────────┐   │
│  │ 将被删除 (5):                                        │   │
│  │   • 技术/旧版代码 (30天前创建)                       │   │
│  │   • 娱乐/已看视频 (15天前创建)                       │   │
│  │   • 学习/临时笔记 (7天前创建)                        │   │
│  │   ...                                                 │   │
│  │                                                       │   │
│  │ 将被保留 (2):                                        │   │
│  │   • 收藏 (系统文件夹需要保留)                        │   │
│  │   • 最近使用 (系统文件夹需要保留)                    │   │
│  │                                                       │   │
│  │ [确认清理 (5个)]                                      │   │
│  └─────────────────────────────────────────────────────┘   │
└──────────────────────────┬──────────────────────────────────┘
                           │
                           │ 点击确认
                           ▼
┌─────────────────────────────────────────────────────────────┐
│  执行中...                                                  │
│  [████████████████████████████████████████] 100%            │
└──────────────────────────┬──────────────────────────────────┘
                           │
                           ▼
┌─────────────────────────────────────────────────────────────┐
│  清理完成                                                    │
│  ✅ 已删除 5 个空文件夹                                      │
│  ⏱️ 耗时 0.5 秒                                              │
│  [确定]                                                     │
└─────────────────────────────────────────────────────────────┘
```

## 6. 性能优化流程

```
大规模数据（10,000+ 文件夹）优化：

┌─────────────────────────────────────────────────────────────┐
│  优化策略1: 批量查询                                         │
│  ❌ N+1 查询: 10,000+ 次数据库请求                          │
│  ✅ 批量查询: 2 次数据库请求（folders + bookmarks）         │
└─────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────┐
│  优化策略2: 分页处理                                         │
│  batchSize = 100                                            │
│  FOR i = 0 TO total STEP 100:                              │
│    batch = emptyFolders.slice(i, i + 100)                 │
│    processBatch(batch)                                     │
│    onProgress(i + 100, total)  ← 更新进度条                │
│    await delay(10ms)  ← 避免阻塞 UI                        │
│  END FOR                                                    │
└─────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────┐
│  优化策略3: Web Worker 后台处理                              │
│  主线程: UI 渲染                                            │
│  Worker:  数据处理和删除                                    │
│  通信: postMessage 传递进度和结果                           │
└─────────────────────────────────────────────────────────────┘
```

## 7. 错误处理流程

```
┌─────────────────────────────────────────────────────────────┐
│  错误类型1: 数据库错误                                       │
│  → 记录日志到 logger.error()                                │
│  → 添加到 warnings 列表                                      │
│  → 继续处理下一个                                            │
└─────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────┐
│  错误类型2: 外键约束                                         │
│  → 移动书签到父文件夹                                        │
│  → 再删除文件夹                                              │
└─────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────┐
│  错误类型3: 权限错误                                         │
│  → 显示友好错误提示                                          │
│  → 建议用户手动处理                                          │
└─────────────────────────────────────────────────────────────┘
```
